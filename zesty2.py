import hashlib
import base64
from Crypto.Cipher import AES
from Crypto.Util.Padding import unpad

# Given values from chall.txt
p = 8600933471903931952242977773230631783962522187222934907406755296232931047170870156586755547198153519435972228077359140442623004111111401785206712035778707
ts = [3163645475595853703416213288902740597700007209583980546534440451597230924540115279412974680047715352962722194509238246295744856150691011330695201268153411, 4043255126229124856891986586666754843176747547624024024148760903562643306946575529282665800918574226481254066339431810483092463214412143880099599937318249, 7049696114844986235757368572291119183909719447458577392399425574235205193257316980297945172813486293139088707221299829921471637880851980201851406750574214, 4764570032155221219249821149344529916476097265305300342213767294304993507096766872890972039939812641898449024781502983290736477476603905280964896996578618, 947673235515463104781827404373490373922985383725646746189127800777298074669393861728894566803583990618667919922293763257953661865298470647745570250529807, 3651907871883559576934907667242633373821441128153730396535281076688908445963253855491900438224396631081841380285337938800227658857008364495254176383504104, 2652817214427143198144623264265151977141841325092925335620198189577761913364724200664925394604348507141636373938680279741994186790528403372394238746195313, 735283329363366037896975327096415371605883319080635476905264025364204168208190022886650602054281522254844991488977653550567569918280009750933450896830761, 4820996289216252389059576466548094953824032594124964429010438590393706416040902977245524607989429293883801154823123028365567554858536630763819185536516065, 6530799527742556754235472219780433614334715666121305259133823870890436632654736816457417169578159115767329534734120244369751407063618584832540626934348183, 7985414377832127628622839723422435232380840336628659610984777967800475689487354071862734335897318249884150437223036210076153574860343048954490508439963030, 1541798682362388741264076215021566208413564794928664567086908345751401733550321277852686199530428083394934117620439678610201614175026346291004271675741197, 5916742357327564296492457737566871246079286342318511299380195709440658029526186161525139350619267021677840622522995769496255905240960337606711510147629670, 4056283211230834310372444546244720453755934393704443394844093782956328873644890297493899315185233192856466926767796864740129933101571187148654734498066301, 404429506705823271375555167196219150276781138590507329030508611751153223782994471422468978122513397378754287746497843649882904328864153668215523003779608, 1122230508984024731014431656047229813237982515616676578569457761337840613880041361955519882653252983060728817537662775996939048654480051626658756020519079, 2623356000089432291140769228826056789255299332782035327197235017790437204583593051387116417128170977827611739914739381741334062647722311196323134928002100, 7335287412816977199997250003420854343217695849616898657955721109380230242538124367349623297883529352158140997215909264910734938589596413988202660213140622, 698746485977581080920042990265699867164759189754476066470390821595222687247537198300935700675019148916721956743586637439972439166347475196589876856104914, 6702065359960882256474794635100128075157967174346623679235013653332121012457608984430350374703538055826265076439246573219468450107819655698689616365634256]
zs = [1633290550762920975324112198366661209358382114434084527320072522540814487411240702972179015595090874947677948834092177850875334873936143379298456636219745, 7685424906490622931454433642348674358660913506439249036382302033133660413932609842153356955209828005561237553395329982942728175240413818607084247973654305, 1708950177191925958754201725972585627190133468827481347899997848165191530635893399437122641671123481627215319904978652948636437037735405413633150835795080, 5523645434999786921677485958602799557345108767868567354263914300571268396503012169802036989947574357888898526231315275750348572840329101004356843295071269, 2489427777468058734399519239315147233458989667259789531824731305323150049236219655737325957340463114775322600078638222898192977495938523929235750819721576, 6440163492364343091081099002907675358092038504075515206428328341214790633935476074719550779658475012464542685117981589181783715247593924463137681824022146, 5788582582867399273268054471050760314100006264948756899104001777220998903232548017627890116004882534539045849566265847286700228203181688382305484375852017, 1173498274746655580192124653684429696712913885485935994006547508671405163425418223370942912393309460601819555236683500852840502939333357339254150782155024, 387697249385640692752734519028990744118816442039921414093326115457619734248033087536756448594842000434517406000752790743930211693226570122809802502961981, 328319666436808255572799995529908799064026141888969701099300462278836089362851385643557309819055522045239391107148205833274223955667996727999576690786103, 149182601630459007410903952875711277142212415485708693796497725675589961372845050032679048281959705193634028419906555148444276276944030528245959040801620, 1877689247920893495528043435970725137815724927736390981055669741738631650671887827169503368569389906911167304272113186401016125957379714101560967144472914, 3958555826094039330032703233733148685023149694012042634207748084989101351870656228129067985345229834745101026649616325996541221740084587988809009065816859, 855890871730436963369032109702426020020493949468768474873897434920834612071421398219751491262285910932010828094847415693257595675918588921069558672557558, 7945018418812032705581679586959560875662809324064276758110855630742521268808070363401226898487692372710067706391729476703979706407293004151374500777574062, 2065729859688430488685715623761885452756287962434166572902641731272016788033442951959854701264232239570640802440093491647730507216206105322729736666303156, 8513393576592547770579340715058053477969449531883423834195370869402553221603531555768620691595452627142354247485594257605842916672143482624196585804525845, 336189773992406230091355273540804912079764666237118164696028387813998195684478762502937885716170152571203140783176366109383971604996704870747783260617604, 4013918482429358981073459032031790863674542747625280239446574011937674222101188425817456527401238001495429067491351225724481025155066547278828336617982238, 6374896028623153339096118438662323825642337859334737191136628501498467182463267623106974115233472013485852820465929678053559448143421614931030178750258336]
enc = 'HTP8lz5u/NrMiXvZY07YqgJgdNb/H4gMj2g1iE2HX/SDPR+3xg3VjNH4sXJU4QvU'

# From the challenge code:
# For even indices (i % 2 == 0): zs[i] = (ts[i] * a^2 + a) mod p
# For odd indices (i % 2 == 1): zs[i] = (ts[i] * a^(-1)) mod p

# From odd indices, we can recover a:
# zs[i] = ts[i] * a^(-1) mod p
# zs[i] * a = ts[i] mod p
# a = ts[i] * zs[i]^(-1) mod p

def mod_inverse(x, mod):
    """Compute modular inverse using extended Euclidean algorithm"""
    return pow(x, -1, mod)

# Try to recover 'a' from odd indices
d = 20
candidates = []
for i in range(1, d, 2):  # odd indices: 1, 3, 5, ..., 19
    try:
        zs_inv = mod_inverse(zs[i], p)
        a_candidate = (ts[i] * zs_inv) % p
        candidates.append(a_candidate)
        print(f"From index {i}: a = {a_candidate}")
    except Exception as e:
        print(f"Error at index {i}: {e}")

# All odd indices should give the same 'a', so take the first one
if candidates:
    a = candidates[0]
    print(f"\nRecovered a = {a}")
    
    # Verify with even indices
    print("\nVerifying with even indices:")
    for i in range(0, d, 2):  # even indices: 0, 2, 4, ..., 18
        expected = (ts[i] * pow(a, 2, p) + a) % p
        actual = zs[i]
        if expected == actual:
            print(f"Index {i}: Match")
        else:
            print(f"Index {i}: Mismatch (expected {expected}, got {actual})")
    
    # Decrypt the flag
    print("\nDecrypting flag...")
    key = hashlib.sha256(str(a).encode()).digest()
    encrypted_data = base64.b64decode(enc)
    iv = encrypted_data[:16]
    ct = encrypted_data[16:]
    
    cipher = AES.new(key, AES.MODE_CBC, iv)
    flag = unpad(cipher.decrypt(ct), AES.block_size)
    print(f"\nFlag: {flag.decode()}")
else:
    print("Failed to recover 'a'")

